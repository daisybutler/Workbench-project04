{% extends "base.html" %}
{% load static %}

{% block content %}
<div id="checkout-order-container" class="container">

    <!--- Order Details --->
    <div class="row">
        <div class="col-12 col-md-8">
            <h1>Checkout</h1>
        </div>
    </div>
    <form id="order-details" action="">
        <div class="row">
            <div class="col-12 col-md-8">
                <hr>
                <div class="row">
                    <div class="col-12">
                        <input class="form-control-lg" type="text" placeholder="{{ order.friendly_name }}"
                            aria-label="{{ order.friendly_name }}" readonly>
                    </div>
                    <div class="col-6">
                        <input id="subscription-date" class="form-control" type="text" placeholder="Starting: [date]"
                            aria-label="Starting date" readonly>
                    </div>
                    <div class="col-6">
                        <input id="price-field" class="form-control" type="number" value="{{ order.price }}"
                            aria-label="Price" readonly>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6">
                        <textarea style="overflow: visible;" class="form-control" type="text"
                            placeholder="Includes: {{ order.short_description }}" aria-label="Order description"
                            readonly></textarea>
                    </div>
                    <div id="qty-selection-area" class="col-6">
                        <label for="qty-dropdown">Qty:</label>
                        <select id="qty-dropdown" class="form-select" aria-label="qty">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6 (max)</option>
                        </select>
                    </div>
                </div>
                <hr>
            </div>
    </form>

    <!--- Order Summary Box --->
    <div id="order-summary-box" class="col-12 col-md-4">
        <h3>Order Summary</h3>
        <div class="row">
            <div class="col-6">
                <p><span id="summary-qty">1 </span> x {{ order.friendly_name }}</p>
            </div>
            {% if order.name == 'one-off-plan' %}
            <div class="col-6">
                <p>£<span id="summary-price">{{ order.price }}</span></p>
            </div>
            <div class="col-12">
                <hr>
                <p>Your card will be charged £<span id="summary-price-textarea">{{ order.price }}</span> today as a one
                    off payment.</p>
                <hr>
            </div>
            {% else %}
            <div class="col-6">
                <p>£<span id="summary-price">{{ order.price }}</span>/mo</p>
            </div>
            <div class="col-12">
                <hr>
                <p>Your card will be charged £<span id="summary-price-textarea">{{ order.price }}</span> today and
                    subsequently each month the same amount. You
                    can
                    cancel at any time.</p>
                <hr>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!--- Customer Details --->
<div class="container">
    <form action="{% url 'checkout_payment' %}" method="POST" class="row">
        {% csrf_token %}
        <fieldset>
            <h2>Billing Details</h2>
            <div class="col-12">
                <label for="fname" class="form-label">First Name*</label>
                <input type="text" class="form-control" id="fname" required>
            </div>
            <div class="col-12">
                <label for="lname" class="form-label">Last Name*</label>
                <input type="text" class="form-control" id="lname" required>
            </div>
            <div class="col-12">
                <label for="email" class="form-label">Email*</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="col-12">
                <label for="password" class="form-label">Password*</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="col-12">
                <label for="phone-number" class="form-label">Phone Number*</label>
                <input type="text" class="form-control" id="phone-number" required>
            </div>
            <div class="col-12">
                <label for="billing-address" class="form-label">Address*</label>
                <input type="text" class="form-control" id="billing-address" placeholder="1234 Main St" required>
            </div>
            <div class="col-12">
                <label for="county" class="form-label">County*</label>
                <select id="county" class="form-select" required>
                    <option readonly disabled selected>Select...</option>
                    <optgroup label="England">
                        <option>Bedfordshire</option>
                        <option>Berkshire</option>
                        <option>Bristol</option>
                        <option>Buckinghamshire</option>
                        <option>Cambridgeshire</option>
                        <option>Cheshire</option>
                        <option>City of London</option>
                        <option>Cornwall</option>
                        <option>Cumbria</option>
                        <option>Derbyshire</option>
                        <option>Devon</option>
                        <option>Dorset</option>
                        <option>Durham</option>
                        <option>East Riding of Yorkshire</option>
                        <option>East Sussex</option>
                        <option>Essex</option>
                        <option>Gloucestershire</option>
                        <option>Greater London</option>
                        <option>Greater Manchester</option>
                        <option>Hampshire</option>
                        <option>Herefordshire</option>
                        <option>Hertfordshire</option>
                        <option>Isle of Wight</option>
                        <option>Kent</option>
                        <option>Lancashire</option>
                        <option>Leicestershire</option>
                        <option>Lincolnshire</option>
                        <option>Merseyside</option>
                        <option>Norfolk</option>
                        <option>North Yorkshire</option>
                        <option>Northamptonshire</option>
                        <option>Northumberland</option>
                        <option>Nottinghamshire</option>
                        <option>Oxfordshire</option>
                        <option>Rutland</option>
                        <option>Shropshire</option>
                        <option>Somerset</option>
                        <option>South Yorkshire</option>
                        <option>Staffordshire</option>
                        <option>Suffolk</option>
                        <option>Surrey</option>
                        <option>Tyne and Wear</option>
                        <option>Warwickshire</option>
                        <option>West Midlands</option>
                        <option>West Sussex</option>
                        <option>West Yorkshire</option>
                        <option>Wiltshire</option>
                        <option>Worcestershire</option>
                    </optgroup>
                    <optgroup label="Wales">
                        <option>Anglesey</option>
                        <option>Brecknockshire</option>
                        <option>Caernarfonshire</option>
                        <option>Carmarthenshire</option>
                        <option>Cardiganshire</option>
                        <option>Denbighshire</option>
                        <option>Flintshire</option>
                        <option>Glamorgan</option>
                        <option>Merioneth</option>
                        <option>Monmouthshire</option>
                        <option>Montgomeryshire</option>
                        <option>Pembrokeshire</option>
                        <option>Radnorshire</option>
                    </optgroup>
                    <optgroup label="Scotland">
                        <option>Aberdeenshire</option>
                        <option>Angus</option>
                        <option>Argyllshire</option>
                        <option>Ayrshire</option>
                        <option>Banffshire</option>
                        <option>Berwickshire</option>
                        <option>Buteshire</option>
                        <option>Cromartyshire</option>
                        <option>Caithness</option>
                        <option>Clackmannanshire</option>
                        <option>Dumfriesshire</option>
                        <option>Dunbartonshire</option>
                        <option>East Lothian</option>
                        <option>Fife</option>
                        <option>Inverness-shire</option>
                        <option>Kincardineshire</option>
                        <option>Kinross</option>
                        <option>Kirkcudbrightshire</option>
                        <option>Lanarkshire</option>
                        <option>Midlothian</option>
                        <option>Morayshire</option>
                        <option>Nairnshire</option>
                        <option>Orkney</option>
                        <option>Peeblesshire</option>
                        <option>Perthshire</option>
                        <option>Renfrewshire</option>
                        <option>Ross-shire</option>
                        <option>Roxburghshire</option>
                        <option>Selkirkshire</option>
                        <option>Shetland</option>
                        <option>Stirlingshire</option>
                        <option>Sutherland</option>
                        <option>West Lothian</option>
                        <option>Wigtownshire</option>
                    </optgroup>
                    <optgroup label="Northern Ireland">
                        <option>Antrim</option>
                        <option>Armagh</option>
                        <option>Down</option>
                        <option>Fermanagh</option>
                        <option>Londonderry</option>
                        <option>Tyrone</option>
                    </optgroup>
                </select>
            </div>
            <div class="col-12">
                <label for="postcode" class="form-label">Postcode*</label>
                <input type="text" class="form-control" id="postcode" required>
            </div>
            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="T&Ccheckbox" required>
                    <label class="form-check-label" for="T&Ccheckbox">
                        I agree to the Terms and Conditions*
                    </label>
                </div>
            </div>
            <div class="col-12 text-center">
                <button class="button">Next</button>
            </div>
        </fieldset>
        <fieldset class="px-3">
            <h2>Payment Details</h2>
            <!-- A Stripe card element will go here -->
            <div id="card-element"></div>

            <!-- Used to display form errors -->
            <div class="mb-3 text-danger" id="card-errors" role="alert"></div>
            <div class="col-12 submit-button text-center">
            <button id="submit-button" class="btn btn-black rounded-0">
                <span class="font-weight-bold">Complete Order</span>
                <span class="icon">
                    <i class="fas fa-lock"></i>
                </span>
            </button>
            <p class="small text-danger my-0">
                <span class="icon">
                    <i class="fas fa-exclamation-circle"></i>
                </span>
                <span>Your card will be charged £<strong id="payment-warning">{{ order.price }}</strong></span>
            </p>
        </div>
        </fieldset>
        
    </form>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {

        // Updates the order summary to match user's changes.
        var qty;
        var price = $("#price-field").val();

        // Updates the order summary qty to match user's qty input.
        $("#qty-dropdown").change(function () {
            qty = $(this).val();
            $("#summary-qty").html(qty);

            // Updates both price displays to match user's qty selection.
            var newPrice = price * qty;
            $("#price-field").val(newPrice);
            $("#summary-price").html(newPrice);
            $("#summary-price-textarea").html(newPrice);
            $("#payment-warning").html(newPrice);

        });

        // Get current date to start subscription from 
        var today = new Date().toISOString().slice(0, 10);
        $("#subscription-date").val("Starting date: " + today);
    });
</script>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{{ stripe_public_key|json_script:"id_stripe_public_key" }}
{{ client_secret|json_script:"id_client_secret" }}
<script>
var stripePublicKey = $('#id_stripe_public_key').text().slice(1, -1);
var clientSecret = $('#id_client_secret').text().slice(1, -1);
var stripe = Stripe(stripePublicKey);
var elements = stripe.elements();
var style = {
    base: {
        color: '#000',
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
            color: '#aab7c4'
        }
    },
    invalid: {
        color: '#dc3545',
        iconColor: '#dc3545'
    }
};
var card = elements.create('card', { style: style });
card.mount('#card-element');

// Handle realtime validation errors on the card elements
card.addEventListener('change', function (event) {
    var errorDiv = document.getElementById('card-errors');
    if (event.error) {
        var html = `
            <span class="icon" role="alert">
                <i class="fas fa-times></i>
            </span>
            <span>${event.error.message}</span>
        `;
        $(errorDiv).html(html);
    } else {
        errorDiv.textContext = '';
    }
});

// Handle form submit
var form = document.getElementById('payment-form');

form.addEventListener('submit', function (ev) {

    // Prevents default action, which is post
    ev.preventDefault();

    // Prevents multiple submissions
    card.update({ 'disabled': true });
    $('#submit-button').attr('disabled', true);
    $('#payment-form').fadeToggle(100);
    $('#loading-overlay').fadeToggle(100);

    var saveInfo = Boolean($('#id-save-info').attr('checked'));
    // From using {% csrf_token %} in the form
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
    var postData = {
        'csrfmiddlewaretoken': csrfToken,
        'client_secret': clientSecret,
        'save_info': saveInfo,
    };
    var url = '/checkout/cache_checkout_data/';

    // Send card info securely to Stripe
    $.post(url, postData).done(function () {
        stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: card,
                billing_details: {
                    name: $.trim(form.full_name.value),
                    phone: $.trim(form.phone_number.value),
                    email: $.trim(form.email.value),
                    address: {
                        line1: $.trim(form.street_address1.value),
                        line2: $.trim(form.street_address2.value),
                        city: $.trim(form.town_or_city.value),
                        country: $.trim(form.country.value),
                        state: $.trim(form.county.value),
                    }
                }
            },
            shipping: {
                name: $.trim(form.full_name.value),
                phone: $.trim(form.phone_number.value),
                address: {
                    line1: $.trim(form.street_address1.value),
                    line2: $.trim(form.street_address2.value),
                    city: $.trim(form.town_or_city.value),
                    country: $.trim(form.country.value),
                    postal_code: $.trim(form.postcode.value),
                    state: $.trim(form.county.value),
                }
            },

            // Then execute this function
        }).then(function (result) {

            // If there's an error, display it in error card like above
            if (result.error) {
                var errorDiv = document.getElementById('card-errors');
                var html = `
                <span class="icon" role="alert">
                <i class="fas fa-times"></i>
                </span>
                <span>${result.error.message}</span>`;
                $(errorDiv).html(html);
                $('#payment-form').fadeToggle(100);
                $('#loading-overlay').fadeToggle(100);

                // If there is an error, we need to re-enable submit button so user can fix
                card.update({ 'disabled': false });
                $('#submit-button').attr('disabled', false);

            } else {
                // If successful payment intent, submit the form
                if (result.paymentIntent.status === 'succeeded') {
                    form.submit();
                }
            }
        });

    }).fail(function () {
        // just reload the page, the error will be in django messages
        location.reload();
    })
});

</script>
{% endblock %}